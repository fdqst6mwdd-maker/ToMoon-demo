<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonlog</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-card: #1a1d24;
            --bg-panel: #232730;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #334155;
            --sidebar-width: 250px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- Main Layout --- */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .page-section { display: none; animation: fadeIn 0.3s; flex-direction: column; gap: 20px; }
        .page-section.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); }
        .btn-sm { padding: 4px 10px; font-size: 11px; }
        
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 11px; background: var(--bg-panel); color: var(--text-muted); display: inline-block; }
        .tag.win { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .tag.loss { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* --- Mission Control Styles --- */
        .mission-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .mission-col { display: flex; flex-direction: column; gap: 20px; }
        
        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .stat-card { background: var(--bg-panel); padding: 15px; border-radius: 8px; display: flex; flex-direction: column; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
        .stat-value { font-size: 20px; font-weight: 700; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr) 100px; gap: 10px; margin-top: 15px; }
        .cal-day { background: var(--bg-panel); border-radius: 8px; min-height: 80px; padding: 10px; position: relative; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .cal-day:hover { border-color: var(--primary); }
        .cal-day.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        .cal-date { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; display: block; }
        .cal-pnl { font-size: 14px; font-weight: 600; display: block; }
        .cal-week-summary { background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px dashed var(--border); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 12px; color: var(--text-muted); }

        .todo-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-panel); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .todo-item:hover { background: rgba(255,255,255,0.05); }
        .todo-title { font-size: 13px; font-weight: 600; }
        .todo-desc { font-size: 11px; color: var(--text-muted); }
        
        /* --- TradeLog Styles --- */
        .filter-bar { display: flex; gap: 10px; }
        .filter-btn { padding: 6px 12px; background: var(--bg-panel); border-radius: 6px; font-size: 12px; cursor: pointer; color: var(--text-muted); border: 1px solid transparent; }
        .filter-btn.active { background: var(--primary); color: white; }
        
        .pending-bar { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--warning); padding: 10px 15px; border-radius: 8px; margin-bottom: 0; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }

        .trade-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .trade-table th { text-align: left; padding: 12px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-weight: 500; }
        .trade-table td { padding: 12px; border-bottom: 1px solid var(--bg-panel); color: var(--text-main); vertical-align: middle; }
        .trade-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }
        .badge-long { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-short { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        /* --- SessionLog Styles --- */
        .session-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .session-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .session-title { font-weight: 600; font-size: 14px; }
        .session-meta { font-size: 12px; color: var(--text-muted); }

        /* --- Session Detail (Review) Styles --- */
        .completion-bar { display: flex; gap: 2px; margin-bottom: 20px; background: var(--bg-panel); padding: 4px; border-radius: 8px; }
        .completion-step { flex: 1; text-align: center; padding: 8px; font-size: 12px; color: var(--text-muted); border-radius: 6px; transition: 0.2s; cursor: pointer; }
        .completion-step:hover { background: rgba(255,255,255,0.03); }
        .completion-step.active { background: var(--bg-card); color: var(--text-main); font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .completion-step.done { color: var(--success); background: rgba(16, 185, 129, 0.05); }

        .review-section { margin-bottom: 30px; }
        .review-title { font-size: 14px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        /* --- Highlights Styles --- */
        .tab-header { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 0; background: var(--bg-card); border-radius: 12px 12px 0 0; }
        .tab-item { padding: 15px 20px; cursor: pointer; color: var(--text-muted); font-size: 13px; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-item:hover { color: var(--text-main); }
        .tab-item.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; background: rgba(59, 130, 246, 0.02); }
        .tab-content { display: none; animation: fadeIn 0.2s; padding: 20px; }
        .tab-content.active { display: block; }

        .highlight-card { background: var(--bg-panel); border-left: 3px solid var(--primary); padding: 15px; border-radius: 6px; margin-bottom: 10px; }
        .highlight-text { font-size: 13px; line-height: 1.5; margin-bottom: 8px; }
        .highlight-meta { font-size: 11px; color: var(--text-muted); display: flex; justify-content: space-between; }

        .note-card { background: var(--bg-panel); padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; }
        .note-card:hover { border-color: var(--primary); }
        .note-title { font-weight: 600; font-size: 14px; margin-bottom: 5px; }
        .note-preview { font-size: 12px; color: var(--text-muted); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- Drawer --- */
        .drawer { position: fixed; top: 0; right: -450px; width: 450px; height: 100vh; background: var(--bg-card); border-left: 1px solid var(--border); transition: right 0.3s; z-index: 1000; padding: 20px; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.5); box-sizing: border-box; }
        .drawer.open { right: 0; }
        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .drawer-content { flex: 1; overflow-y: auto; }
        .drawer-footer { padding-top: 15px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        /* --- Forms --- */
        .moonlog-form { display: flex; flex-direction: column; gap: 15px; }
        .form-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; display: block; }
        .summary-input { width: 100%; background: var(--bg-panel); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        
        .star-rating { display: flex; gap: 5px; }
        .star { font-size: 20px; color: var(--border); cursor: pointer; }
        .star.active { color: #fbbf24; }
        
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn { padding: 10px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); cursor: pointer; text-align: center; font-size: 13px; }
        .option-btn:hover { border-color: var(--primary); }
        .option-btn.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--primary); color: var(--primary); font-weight: 600; }

        .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; }
        .log-tag { padding: 6px 12px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 20px; font-size: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
        .log-tag.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        .insight-box { background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-top: 10px; }

        /* --- Toast Notification --- */
        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--bg-panel); border: 1px solid var(--primary); color: var(--text-main); padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; display: flex; align-items: center; gap: 10px; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-icon { color: var(--primary); font-size: 18px; }

        /* --- Modal Overlay --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1500; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { width: 500px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        /* --- Search Input --- */
        .search-input { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text-main); font-size: 13px; width: 200px; }
        .search-input::placeholder { color: var(--text-muted); }

        /* --- Progress Indicator --- */
        .progress-mini { height: 4px; background: var(--bg-panel); border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.3s; }

        /* --- Highlight Card Enhanced --- */
        .highlight-card { position: relative; }
        .highlight-actions { display: flex; gap: 8px; margin-top: 10px; }
        .highlight-card.pinned { border-left-color: var(--warning); }
        .highlight-card.reviewed { opacity: 0.6; }
        .pin-badge { position: absolute; top: 10px; right: 10px; font-size: 14px; }

        /* --- Note Card Enhanced --- */
        .note-type-icon { font-size: 16px; margin-right: 8px; }
        .link-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(59, 130, 246, 0.1); color: var(--primary); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px; }

        /* --- Mini Trade List --- */
        .mini-trade-item { background: var(--bg-panel); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--warning); }
        .mini-trade-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .mini-trade-rating { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        /* --- Empty State --- */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        .empty-state-title { font-size: 16px; font-weight: 600; color: var(--text-main); margin-bottom: 5px; }

        /* --- Custom Highlight Input --- */
        .custom-highlight-input { display: none; margin-top: 10px; }
        .custom-highlight-input.active { display: block; }

        /* --- Link Chips --- */
        .link-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .link-chip { display: inline-flex; align-items: center; gap: 5px; background: rgba(59, 130, 246, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 12px; }
        .link-chip .remove { cursor: pointer; opacity: 0.7; }
        .link-chip .remove:hover { opacity: 1; }

        /* --- Link Selection Item --- */
        .link-select-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .link-select-item:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        .link-select-item.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .link-select-icon { font-size: 20px; width: 32px; text-align: center; }
        .link-select-info { flex: 1; }
        .link-select-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .link-select-meta { font-size: 11px; color: var(--text-muted); }
        .link-select-check { color: var(--primary); font-size: 16px; opacity: 0; }
        .link-select-item.selected .link-select-check { opacity: 1; }

    </style>
</head>
<body>

<!-- Toast -->
<div id="toast" class="toast">
    <span class="toast-icon">✓</span>
    <span id="toast-msg">Action Completed</span>
</div>

<!-- Unrated Trades Modal -->
<div class="modal-overlay" id="unrated-modal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 style="margin: 0;">Rate Pending Trades</h3>
            <span style="cursor: pointer; color: var(--text-muted);" onclick="closeUnratedModal()">✕</span>
        </div>
        <div class="modal-body" id="unrated-modal-body">
            <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeUnratedModal()">Later</button>
            <button class="btn btn-primary" onclick="saveAllUnratedTrades()">Save All Ratings</button>
        </div>
    </div>
</div>

<!-- Highlight Detail Modal -->
<div class="modal-overlay" id="highlight-detail-modal">
    <div class="modal-box" style="width: 550px;">
        <div class="modal-header">
            <h3 style="margin: 0;">Highlight Detail</h3>
            <span style="cursor: pointer; color: var(--text-muted);" onclick="closeHighlightDetail()">✕</span>
        </div>
        <div class="modal-body" id="highlight-detail-body">
            <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeHighlightDetail()">Close</button>
        </div>
    </div>
</div>

<!-- Link Selection Modal -->
<div class="modal-overlay" id="link-modal">
    <div class="modal-box" style="width: 450px;">
        <div class="modal-header">
            <h3 style="margin: 0;" id="link-modal-title">Select Item to Link</h3>
            <span style="cursor: pointer; color: var(--text-muted);" onclick="closeLinkModal()">✕</span>
        </div>
        <div class="modal-body" id="link-modal-body" style="max-height: 400px; overflow-y: auto;">
            <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeLinkModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Sidebar (Generated by shared module) -->
<aside class="sidebar" id="sidebar"></aside>
<script src="../shared/sidebar.js"></script>
<script src="../shared/topbar.js"></script>
<script>
    // Auto-init sidebar
    autoInitSidebar({ 
        internalSwitch: true, 
        switchFunction: 'switchViewFromSidebar',
        title: 'Moonlog'
    });
    
    // 初始化 Topbar（包含全局 Quick Journal）
    initTopbar({ title: 'Moonlog' });
    
    function switchViewFromSidebar(viewId) {
        switchView(viewId);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view') || 'missioncontrol';
        switchView(view);
        updateSidebarActive(view);
    });
</script>

<main class="main-content">
    
    <!-- VIEW 1: Mission Control -->
    <div id="view-missioncontrol" class="page-section active">
        <div class="header-row">
            <div>
                <h2 style="margin: 0;">Mission Control</h2>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-muted);">Your trading command center. Review, reflect, and prepare.</p>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='../Strategy/Strategy_demo_v1.5.html?view=dashboard'">+ Start Session</button>
        </div>

        <div class="mission-grid">
            <!-- Left Col -->
            <div class="mission-col">
                <!-- Status Card -->
                <div class="card">
                    <div class="header-row" style="margin-bottom: 15px;">
                        <h3 style="font-size: 16px; margin: 0;">Today / Last Session</h3>
                        <span class="tag win">Completed</span>
                    </div>
                    <div class="stats-bar" style="margin-bottom: 15px;">
                        <div class="stat-card">
                            <span class="stat-label">Execution Quality</span>
                            <span class="stat-value text-green">High (4.8)</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Risk Guard</span>
                            <span class="stat-value text-green">Safe</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Trades</span>
                            <span class="stat-value">12 <span style="font-size: 12px; color: var(--text-muted); font-weight: normal;">(All Rated)</span></span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Net P&L</span>
                            <span class="stat-value text-green">+$1,240</span>
                        </div>
                    </div>
                    <!-- CTA Area -->
                    <div style="display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid var(--bg-panel);">
                        <button class="btn btn-sm btn-outline" onclick="switchView('sessionlog')">View Details</button>
                        <span style="flex: 1;"></span>
                        <span style="font-size: 12px; color: var(--text-muted); align-self: center;">All caught up!</span>
                    </div>
                </div>

                <!-- Timeline / Heatmap -->
                <div class="card">
                    <div class="header-row" style="margin-bottom: 15px;">
                        <h3 style="font-size: 16px; margin: 0;">30-Day Consistency</h3>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-outline btn-sm active">Quality</button>
                            <button class="btn btn-outline btn-sm">P&L</button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <!-- Mock Calendar Days -->
                        <div class="cal-day active"><span class="cal-date">Dec 28</span><span class="cal-pnl text-green">4.5</span></div>
                        <div class="cal-day"><span class="cal-date">Dec 29</span><span class="cal-pnl text-red">2.1</span></div>
                        <div class="cal-day active"><span class="cal-date">Dec 30</span><span class="cal-pnl text-green">4.8</span></div>
                        <div class="cal-day"><span class="cal-date">Dec 31</span><span class="cal-pnl text-green">3.9</span></div>
                        <div class="cal-day active"><span class="cal-date">Jan 01</span><span class="cal-pnl text-green">5.0</span></div>
                        <div class="cal-day"><span class="cal-date">Jan 02</span><span class="cal-pnl text-green">4.2</span></div>
                        <div class="cal-day active" style="border-color: var(--primary);"><span class="cal-date">Today</span><span class="cal-pnl text-green">4.8</span></div>
                        <div class="cal-week-summary">
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">4.4</span>
                            <span>Avg Quality</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Col -->
            <div class="mission-col">
                <!-- To-Do Panel -->
                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 15px; margin-top: 0;">Action Items</h3>
                    
                    <div class="todo-item" onclick="openSessionDetail('draft-001')">
                        <div>
                            <div class="todo-title">Draft Session (Jan 02)</div>
                            <div class="todo-desc">Ended at 14:30 • Not Closed</div>
                        </div>
                        <button class="btn btn-sm btn-primary">Complete</button>
                    </div>

                    <div class="todo-item" onclick="openUnratedModal()">
                        <div>
                            <div class="todo-title">3 Pending Trades</div>
                            <div class="todo-desc">From Jan 02 Session</div>
                        </div>
                        <button class="btn btn-sm btn-outline">Review</button>
                    </div>
                </div>

                <!-- Highlights Preview -->
                <div class="card">
                    <div class="header-row" style="margin-bottom: 15px;">
                        <h3 style="font-size: 16px; margin: 0;">Highlights</h3>
                        <button class="btn btn-sm btn-outline" onclick="switchView('highlights')">View All</button>
                    </div>
                    
                    <!-- Today's Highlight Section -->
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin-bottom: 8px; font-weight: 600;">Today's Highlight</div>
                        <div class="highlight-card" style="border-left-color: var(--primary); background: rgba(59, 130, 246, 0.05);">
                            <div class="highlight-text" style="font-size: 14px; font-weight: 500;">"Avoid trading the first 5 mins of NQ open when VIX is above 20."</div>
                            <div class="highlight-meta">
                                <span>Jan 02 Session</span>
                                <span class="tag" style="background: rgba(59, 130, 246, 0.1); color: var(--primary);">#Strategy</span>
                            </div>
                            <div class="highlight-actions">
                                <button class="btn btn-sm btn-outline" style="font-size: 10px; padding: 2px 6px;" onclick="showToast('Marked as reviewed')">✓ Reviewed</button>
                            </div>
                        </div>
                    </div>

                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">Recent</div>
                    
                    <div class="highlight-card">
                        <div class="highlight-text">"Great patience on the pullback entry. Waited for the candle close."</div>
                        <div class="highlight-meta">
                            <span>Jan 01 Trade</span>
                            <span>#Discipline</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 2: TradeLog -->
    <div id="view-tradelog" class="page-section">
        <div class="header-row">
            <div>
                <h2 style="margin: 0;">TradeLog</h2>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-muted);">Detailed ledger of every action. Rate and review.</p>
            </div>
            <div class="filter-bar" id="tradelog-filters" style="margin-bottom: 0;">
                <button class="filter-btn active" onclick="filterTrades('all', this)">All</button>
                <button class="filter-btn" onclick="filterTrades('unrated', this)">Unrated</button>
                <button class="filter-btn" onclick="filterTrades('5star', this)">5 Stars</button>
            </div>
        </div>

        <!-- Pending Bar -->
        <div class="pending-bar" id="pending-trades-bar">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">⚠️</span>
                <span>You have <strong>3 unrated trades</strong> from the last session.</span>
            </div>
            <button class="btn btn-sm btn-primary" style="background: #f59e0b; border: none; color: black;" onclick="openUnratedModal()">Review Now</button>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <table class="trade-table" id="trade-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>P&L</th>
                        <th>Quality</th>
                        <th>Deviation</th>
                        <th>Factor</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="trade-table-body">
                    <!-- Unrated Row 1 -->
                    <tr data-status="unrated" style="background: rgba(245, 158, 11, 0.05);">
                        <td>14:15:22</td>
                        <td>NQ</td>
                        <td><span class="badge badge-long">Long</span></td>
                        <td class="text-green">+$120.00</td>
                        <td><span style="color: var(--warning);">Unrated</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td><button class="btn btn-sm btn-primary" onclick="openDrawer('trade', 1)">Rate</button></td>
                    </tr>
                    <!-- Unrated Row 2 -->
                    <tr data-status="unrated" style="background: rgba(245, 158, 11, 0.05);">
                        <td>13:45:10</td>
                        <td>ES</td>
                        <td><span class="badge badge-short">Short</span></td>
                        <td class="text-red">-$80.00</td>
                        <td><span style="color: var(--warning);">Unrated</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td><button class="btn btn-sm btn-primary" onclick="openDrawer('trade', 2)">Rate</button></td>
                    </tr>
                    <!-- Unrated Row 3 -->
                    <tr data-status="unrated" style="background: rgba(245, 158, 11, 0.05);">
                        <td>13:20:05</td>
                        <td>NQ</td>
                        <td><span class="badge badge-long">Long</span></td>
                        <td class="text-green">+$45.00</td>
                        <td><span style="color: var(--warning);">Unrated</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td><button class="btn btn-sm btn-primary" onclick="openDrawer('trade', 3)">Rate</button></td>
                    </tr>
                    <!-- Rated Rows -->
                    <tr data-status="rated" data-stars="4">
                        <td>10:30:05</td>
                        <td>ES</td>
                        <td><span class="badge badge-short">Short</span></td>
                        <td class="text-red">-$50.00</td>
                        <td>⭐⭐⭐⭐</td>
                        <td><span class="tag">No</span></td>
                        <td><span class="tag">Discipline</span></td>
                        <td><button class="btn btn-sm btn-outline" onclick="openDrawer('trade', 4)">Edit</button></td>
                    </tr>
                    <tr data-status="rated" data-stars="5">
                        <td>09:45:12</td>
                        <td>NQ</td>
                        <td><span class="badge badge-long">Long</span></td>
                        <td class="text-green">+$350.00</td>
                        <td>⭐⭐⭐⭐⭐</td>
                        <td><span class="tag">No</span></td>
                        <td><span class="tag">Execution</span></td>
                        <td><button class="btn btn-sm btn-outline" onclick="openDrawer('trade', 5)">Edit</button></td>
                    </tr>
                    <tr data-status="rated" data-stars="5">
                        <td>09:15:30</td>
                        <td>NQ</td>
                        <td><span class="badge badge-long">Long</span></td>
                        <td class="text-green">+$280.00</td>
                        <td>⭐⭐⭐⭐⭐</td>
                        <td><span class="tag">No</span></td>
                        <td><span class="tag">Discipline</span></td>
                        <td><button class="btn btn-sm btn-outline" onclick="openDrawer('trade', 6)">Edit</button></td>
                    </tr>
                    <tr data-status="rated" data-stars="3">
                        <td>09:05:15</td>
                        <td>ES</td>
                        <td><span class="badge badge-short">Short</span></td>
                        <td class="text-green">+$75.00</td>
                        <td>⭐⭐⭐</td>
                        <td><span class="tag" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">Minor</span></td>
                        <td><span class="tag">Emotion</span></td>
                        <td><button class="btn btn-sm btn-outline" onclick="openDrawer('trade', 7)">Edit</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- VIEW 3: SessionLog -->
    <div id="view-sessionlog" class="page-section">
        <div class="header-row">
            <div>
                <h2 style="margin: 0;">SessionLog</h2>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-muted);">Track your sessions and close your books.</p>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='../Strategy/Strategy_demo_v1.5.html?view=dashboard'">+ New Session</button>
        </div>

        <!-- Active Sessions -->
        <div style="margin-bottom: 30px;">
            <h3 style="font-size: 14px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></span>
                Active Now
            </h3>
            <style>@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }</style>
            <div class="session-card" style="border-left: 3px solid var(--success);">
                <div class="session-header">
                    <div class="session-title">Main Account • Scalping Strategy</div>
                    <span class="tag win">Active</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 15px 0;">
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Started</div>
                        <div style="font-size: 14px; font-weight: 600;">09:30</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Trades</div>
                        <div style="font-size: 14px; font-weight: 600;">12</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Risk</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--success);">Safe</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">P&L</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--success);">+$540</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="window.location.href='../Strategy/Strategy_demo_v1.5.html?view=dashboard'">Go to Execute</button>
            </div>
        </div>

        <!-- Draft Sessions -->
        <div style="margin-bottom: 30px;">
            <h3 style="font-size: 14px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--warning);">!</span>
                Drafts (Needs Closing)
                <span style="background: var(--warning); color: black; padding: 2px 8px; border-radius: 10px; font-size: 11px;">1</span>
            </h3>
            <div class="session-card" style="border-left: 3px solid var(--warning);">
                <div class="session-header">
                    <div class="session-title">Jan 02 Afternoon Session</div>
                    <span class="tag" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">Draft</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 15px 0;">
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Time</div>
                        <div style="font-size: 14px; font-weight: 600;">13:00 - 14:30</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Trades</div>
                        <div style="font-size: 14px; font-weight: 600;">5</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Unrated</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--warning);">3 pending</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Progress</div>
                        <div style="font-size: 14px; font-weight: 600;">25%</div>
                    </div>
                </div>
                <div class="progress-mini">
                    <div class="progress-fill" style="width: 25%; background: var(--warning);"></div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="openSessionDetail('draft-001')">Complete Session</button>
                </div>
            </div>
        </div>

        <!-- Completed Sessions -->
        <div>
            <h3 style="font-size: 14px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px;">History</h3>
            
            <!-- Completed Session 1 -->
            <div class="session-card" onclick="openSessionDetail('completed-001')" style="cursor: pointer;">
                <div class="session-header">
                    <div class="session-title">Jan 02 Morning Session</div>
                    <span class="tag">Completed</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 10px 0;">
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Time</div>
                        <div style="font-size: 13px;">09:00 - 11:30</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Trades</div>
                        <div style="font-size: 13px;">8</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Quality</div>
                        <div style="font-size: 13px; color: var(--success);">4.5</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Risk</div>
                        <div style="font-size: 13px; color: var(--success);">Safe</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">P&L</div>
                        <div style="font-size: 13px; color: var(--success);">+$680</div>
                    </div>
                </div>
                <div class="highlight-card" style="margin-bottom: 0; padding: 10px; margin-top: 10px;">
                    <div class="highlight-text" style="font-size: 12px; margin-bottom: 0;">"Great patience on the pullback entry. Waited for the candle close."</div>
                </div>
            </div>

            <!-- Completed Session 2 -->
            <div class="session-card" onclick="openSessionDetail('completed-002')" style="cursor: pointer;">
                <div class="session-header">
                    <div class="session-title">Jan 01 Morning Session</div>
                    <span class="tag">Completed</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 10px 0;">
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Time</div>
                        <div style="font-size: 13px;">09:30 - 12:00</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Trades</div>
                        <div style="font-size: 13px;">10</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Quality</div>
                        <div style="font-size: 13px; color: var(--success);">4.8</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">Risk</div>
                        <div style="font-size: 13px; color: var(--warning);">Touched</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted);">P&L</div>
                        <div style="font-size: 13px; color: var(--success);">+$1,240</div>
                    </div>
                </div>
                <div class="highlight-card" style="margin-bottom: 0; padding: 10px; margin-top: 10px;">
                    <div class="highlight-text" style="font-size: 12px; margin-bottom: 0;">"When risk touched, I stepped back. Good emotional control."</div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 3.5: Session Detail (Review) -->
    <div id="view-session-detail" class="page-section">
        <div class="header-row">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn btn-outline btn-sm" onclick="switchView('sessionlog')">← Back</button>
                <div>
                    <h2 style="margin: 0;">Session Review</h2>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-muted);">Jan 02 Afternoon Session • 13:00 - 14:30</p>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" onclick="saveDraft()">Save Draft</button>
                <button class="btn btn-primary" onclick="tryCompleteSession()">Complete Session</button>
            </div>
        </div>

        <!-- Completion Bar -->
        <div class="completion-bar" id="completion-bar">
            <div class="completion-step" id="step-1" onclick="goToStep(1)">1. Trades Reviewed</div>
            <div class="completion-step" id="step-2" onclick="goToStep(2)">2. Execution Review</div>
            <div class="completion-step" id="step-3" onclick="goToStep(3)">3. Reflection</div>
            <div class="completion-step" id="step-4" onclick="goToStep(4)">4. Highlight Saved</div>
        </div>

        <div class="card">
            <!-- Step 1: Unrated Check -->
            <div class="review-section" id="review-step-1">
                <div class="review-title">
                    <span>1. Unrated Trades Check</span>
                    <span class="tag" id="unrated-status" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">3 Pending</span>
                </div>
                <div id="unrated-trades-section">
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">You have 3 trades that need to be rated before completing this session.</p>
                    
                    <!-- Mini Trade List for Quick Rating -->
                    <div class="mini-trade-item">
                        <div class="mini-trade-header">
                            <span><strong>NQ</strong> Long • +$120.00</span>
                            <span style="color: var(--text-muted);">14:15</span>
                        </div>
                        <div class="mini-trade-rating">
                            <div class="star-rating" data-trade="1">
                                <span class="star" onclick="setMiniStar(1, 1)">★</span>
                                <span class="star" onclick="setMiniStar(1, 2)">★</span>
                                <span class="star" onclick="setMiniStar(1, 3)">★</span>
                                <span class="star" onclick="setMiniStar(1, 4)">★</span>
                                <span class="star" onclick="setMiniStar(1, 5)">★</span>
                            </div>
                            <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                                <option>No Deviation</option>
                                <option>Minor</option>
                                <option>Major</option>
                            </select>
                            <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                                <option>Discipline</option>
                                <option>Emotion</option>
                                <option>Market Noise</option>
                                <option>Execution</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mini-trade-item">
                        <div class="mini-trade-header">
                            <span><strong>ES</strong> Short • -$80.00</span>
                            <span style="color: var(--text-muted);">13:45</span>
                        </div>
                        <div class="mini-trade-rating">
                            <div class="star-rating" data-trade="2">
                                <span class="star" onclick="setMiniStar(2, 1)">★</span>
                                <span class="star" onclick="setMiniStar(2, 2)">★</span>
                                <span class="star" onclick="setMiniStar(2, 3)">★</span>
                                <span class="star" onclick="setMiniStar(2, 4)">★</span>
                                <span class="star" onclick="setMiniStar(2, 5)">★</span>
                            </div>
                            <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                                <option>No Deviation</option>
                                <option>Minor</option>
                                <option>Major</option>
                            </select>
                            <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                                <option>Discipline</option>
                                <option>Emotion</option>
                                <option>Market Noise</option>
                                <option>Execution</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mini-trade-item">
                        <div class="mini-trade-header">
                            <span><strong>NQ</strong> Long • +$45.00</span>
                            <span style="color: var(--text-muted);">13:20</span>
                        </div>
                        <div class="mini-trade-rating">
                            <div class="star-rating" data-trade="3">
                                <span class="star" onclick="setMiniStar(3, 1)">★</span>
                                <span class="star" onclick="setMiniStar(3, 2)">★</span>
                                <span class="star" onclick="setMiniStar(3, 3)">★</span>
                                <span class="star" onclick="setMiniStar(3, 4)">★</span>
                                <span class="star" onclick="setMiniStar(3, 5)">★</span>
                            </div>
                            <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                                <option>No Deviation</option>
                                <option>Minor</option>
                                <option>Major</option>
                            </select>
                            <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                                <option>Discipline</option>
                                <option>Emotion</option>
                                <option>Market Noise</option>
                                <option>Execution</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-sm" onclick="saveAllMiniRatings()" style="margin-top: 10px;">Save All Ratings</button>
                </div>
                
                <!-- Shows when all rated -->
                <div id="all-rated-section" style="display: none;">
                    <p style="font-size: 13px; color: var(--success);">✓ All 5 trades have been rated. Good job.</p>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- Step 2: Execution & Risk -->
            <div class="review-section" id="review-step-2">
                <div class="review-title">2. Execution & Risk Review</div>
                <div class="stats-bar">
                    <div class="stat-card">
                        <span class="stat-label">Avg Quality</span>
                        <span class="stat-value" id="avg-quality">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Risk Status</span>
                        <span class="stat-value text-green">Safe</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Deviations</span>
                        <span class="stat-value">1 <span style="font-size: 12px; color: var(--text-muted);">(Minor)</span></span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Net P&L</span>
                        <span class="stat-value text-green">+$85</span>
                    </div>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- Step 3: Reflection -->
            <div class="review-section" id="review-step-3">
                <div class="review-title">3. Reflection</div>
                <label class="form-label">How did you feel? What went well?</label>
                <textarea class="summary-input" id="reflection-input" rows="4" placeholder="I felt calm today. The market was choppy but I stuck to my plan..." oninput="checkReflection()"></textarea>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- Step 4: Lock Highlight -->
            <div class="review-section" id="review-step-4">
                <div class="review-title">
                    <span>4. Lock One Highlight</span>
                    <span class="tag" style="background: var(--primary); color: white;">Required</span>
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">Select one key takeaway to remember.</p>
                
                <div class="option-grid" style="grid-template-columns: 1fr;" id="highlight-options">
                    <div class="option-btn" style="text-align: left; padding: 15px;" onclick="selectHighlight(this, 'Good discipline on waiting for setups.')">
                        <strong>"Good discipline on waiting for setups."</strong>
                        <div style="font-size: 11px; margin-top: 5px; color: var(--text-muted);">Based on your 5-star trades</div>
                    </div>
                    <div class="option-btn" style="text-align: left; padding: 15px;" onclick="selectHighlight(this, 'Avoid trading during news events.')">
                        <strong>"Avoid trading during news events."</strong>
                        <div style="font-size: 11px; margin-top: 5px; color: var(--text-muted);">Based on your loss trade</div>
                    </div>
                    <div class="option-btn" style="text-align: left; padding: 15px;" onclick="selectHighlight(this, 'Minor deviation but recovered well.')">
                        <strong>"Minor deviation but recovered well."</strong>
                        <div style="font-size: 11px; margin-top: 5px; color: var(--text-muted);">Based on your deviation pattern</div>
                    </div>
                    <div class="option-btn" style="text-align: left; padding: 15px;" onclick="showCustomHighlight()">
                        <strong>✏️ Write your own...</strong>
                        <div style="font-size: 11px; margin-top: 5px; color: var(--text-muted);">Custom highlight</div>
                    </div>
                </div>
                
                <!-- Custom Highlight Input -->
                <div class="custom-highlight-input" id="custom-highlight-box">
                    <label class="form-label" style="margin-top: 15px;">Your Custom Highlight</label>
                    <input type="text" class="summary-input" id="custom-highlight-input" placeholder="Write a one-sentence takeaway..." oninput="customHighlightChanged()">
                    <button class="btn btn-sm btn-primary" style="margin-top: 10px;" onclick="saveCustomHighlight()">Save Custom Highlight</button>
                </div>
            </div>

            <!-- Optional Note -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 15px;">
                <button class="btn btn-outline" onclick="addSessionNote()">+ Add Detailed Note (Optional)</button>
            </div>
        </div>
    </div>

    <!-- VIEW 4: Highlights -->
    <div id="view-highlights" class="page-section">
        <div class="header-row">
            <div>
                <h2 style="margin: 0;">Highlights & Notes</h2>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-muted);">Your knowledge base and value sedimentation.</p>
            </div>
        </div>

        <div class="card" style="padding: 0; min-height: 500px;">
            <div class="tab-header">
                <div class="tab-item active" onclick="switchTab('highlights')">Highlights</div>
                <div class="tab-item" onclick="switchTab('notes')">Notes</div>
            </div>

            <!-- Highlights Tab -->
            <div id="tab-highlights" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="filter-bar" id="highlight-filters">
                        <button class="filter-btn active" onclick="filterHighlights('all', this)">All</button>
                        <button class="filter-btn" onclick="filterHighlights('strategy', this)">Strategy</button>
                        <button class="filter-btn" onclick="filterHighlights('mindset', this)">Mindset</button>
                        <button class="filter-btn" onclick="filterHighlights('discipline', this)">Discipline</button>
                        <button class="filter-btn" onclick="filterHighlights('pinned', this)">Pinned</button>
                    </div>
                    <span style="font-size: 12px; color: var(--text-muted);">6 highlights</span>
                </div>

                <!-- Highlight Cards -->
                <div id="highlights-list">
                    <div class="highlight-card pinned" data-tag="strategy" onclick="openHighlightDetail(1)" style="cursor: pointer;">
                        <span class="pin-badge">📌</span>
                        <div class="highlight-text">"Avoid trading the first 5 mins of NQ open when VIX is above 20."</div>
                        <div class="highlight-meta">
                            <span>📅 Jan 02 Session • <span class="tag" style="margin-left: 5px;">#Strategy</span></span>
                            <div class="highlight-actions">
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); togglePin(this)">Unpin</button>
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); markReviewed(this)">Reviewed</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="highlight-card" data-tag="discipline" onclick="openHighlightDetail(2)" style="cursor: pointer;">
                        <div class="highlight-text">"Stop loss must be placed at technical levels, not dollar amounts."</div>
                        <div class="highlight-meta">
                            <span>📅 Dec 30 Trade • <span class="tag" style="margin-left: 5px;">#Discipline</span></span>
                            <div class="highlight-actions">
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); togglePin(this)">Pin</button>
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); markReviewed(this)">Reviewed</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="highlight-card" data-tag="mindset" onclick="openHighlightDetail(3)" style="cursor: pointer;">
                        <div class="highlight-text">"Great patience on the pullback entry. Waited for the candle close."</div>
                        <div class="highlight-meta">
                            <span>📅 Jan 01 Trade • <span class="tag" style="margin-left: 5px;">#Mindset</span></span>
                            <div class="highlight-actions">
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); togglePin(this)">Pin</button>
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); markReviewed(this)">Reviewed</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="highlight-card" data-tag="discipline" onclick="openHighlightDetail(4)" style="cursor: pointer;">
                        <div class="highlight-text">"When risk touched, I stepped back. Good emotional control."</div>
                        <div class="highlight-meta">
                            <span>📅 Jan 01 Session • <span class="tag" style="margin-left: 5px;">#Discipline</span></span>
                            <div class="highlight-actions">
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); togglePin(this)">Pin</button>
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); markReviewed(this)">Reviewed</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="highlight-card reviewed" data-tag="strategy" onclick="openHighlightDetail(5)" style="cursor: pointer;">
                        <div class="highlight-text">"NQ respects the 15m VWAP in high volatility days."</div>
                        <div class="highlight-meta">
                            <span>📅 Dec 28 Note • <span class="tag" style="margin-left: 5px;">#Strategy</span></span>
                            <div class="highlight-actions">
                                <span style="color: var(--success); font-size: 11px;">✓ Reviewed today</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="highlight-card" data-tag="mindset" onclick="openHighlightDetail(6)" style="cursor: pointer;">
                        <div class="highlight-text">"Don't chase. If you miss it, there will be another setup."</div>
                        <div class="highlight-meta">
                            <span>📅 Dec 27 Session • <span class="tag" style="margin-left: 5px;">#Mindset</span></span>
                            <div class="highlight-actions">
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); togglePin(this)">Pin</button>
                                <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 10px;" onclick="event.stopPropagation(); markReviewed(this)">Reviewed</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div id="tab-notes" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <input type="text" class="search-input" placeholder="Search notes..." oninput="searchNotes(this.value)">
                        <div class="filter-bar" id="notes-filters" style="margin-bottom: 0;">
                            <button class="filter-btn active" onclick="filterNotes('all', this)">My Notes</button>
                            <button class="filter-btn" onclick="filterNotes('linked', this)">Linked Notes</button>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="openDrawer('note')">+ New Note</button>
                </div>

                <div id="notes-list">
                    <div class="note-card" data-linked="true" onclick="openDrawer('note-detail', 1)">
                        <div style="display: flex; align-items: center;">
                            <span class="note-type-icon">📝</span>
                            <div class="note-title">Weekly Review - Week 50</div>
                            <span class="link-badge">🔗 Session</span>
                        </div>
                        <div class="note-preview">
                            Overall a good week. Focused on execution quality rather than P&L. The new scalping strategy is working well in high volatility...
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <span class="tag">Review</span>
                            <span style="font-size: 11px; color: var(--text-muted);">Dec 29, 2025</span>
                        </div>
                    </div>
                    
                    <div class="note-card" data-linked="false" onclick="openDrawer('note-detail', 2)">
                        <div style="display: flex; align-items: center;">
                            <span class="note-type-icon">📈</span>
                            <div class="note-title">Market Thoughts: NQ Volatility</div>
                        </div>
                        <div class="note-preview">
                            Noticed that NQ is respecting the 15m VWAP more than usual. Need to backtest this pattern across different market conditions...
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <span class="tag">Market</span>
                            <span style="font-size: 11px; color: var(--text-muted);">Dec 28, 2025</span>
                        </div>
                    </div>
                    
                    <div class="note-card" data-linked="true" onclick="openDrawer('note-detail', 3)">
                        <div style="display: flex; align-items: center;">
                            <span class="note-type-icon">🧠</span>
                            <div class="note-title">Trading Psychology Notes</div>
                            <span class="link-badge">🔗 Trade</span>
                        </div>
                        <div class="note-preview">
                            When I feel FOMO, I need to remember: there's always another trade. The market doesn't care about my urgency...
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <span class="tag">Mindset</span>
                            <span style="font-size: 11px; color: var(--text-muted);">Dec 26, 2025</span>
                        </div>
                    </div>
                    
                    <div class="note-card" data-linked="false" onclick="openDrawer('note-detail', 4)">
                        <div style="display: flex; align-items: center;">
                            <span class="note-type-icon">🎯</span>
                            <div class="note-title">Strategy Idea: Gap Fill Setup</div>
                        </div>
                        <div class="note-preview">
                            Noticed a pattern on gap days - when ES gaps up more than 0.5%, there's often a fill attempt in the first hour...
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <span class="tag">Strategy</span>
                            <span style="font-size: 11px; color: var(--text-muted);">Dec 24, 2025</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>

<!-- Drawer (Shared for Trade/Note) -->
<div class="drawer" id="main-drawer">
    <div class="drawer-header">
        <h3 style="margin: 0;" id="drawer-title">Edit Trade</h3>
        <button class="btn btn-sm btn-outline" onclick="closeDrawer()">Close</button>
    </div>
    <div class="drawer-content" id="drawer-body">
        <!-- Dynamic Content -->
    </div>
    <div class="drawer-footer">
        <button class="btn btn-outline" onclick="closeDrawer()">Cancel</button>
        <button class="btn btn-primary" onclick="closeDrawer()">Save</button>
    </div>
</div>

<script>
    // ========== STATE MANAGEMENT ==========
    let sessionReviewState = {
        tradesRated: false,
        executionReviewed: false,
        reflectionDone: false,
        highlightSelected: null
    };

    let miniRatings = {
        1: { stars: 0, deviation: 'No Deviation', factor: 'Discipline' },
        2: { stars: 0, deviation: 'No Deviation', factor: 'Discipline' },
        3: { stars: 0, deviation: 'No Deviation', factor: 'Discipline' }
    };

    // ========== VIEW NAVIGATION ==========
    function switchView(viewId) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById('view-' + viewId);
        if(target) target.classList.add('active');
        updateSidebarActive(viewId);
    }

    function switchViewFromSidebar(viewId) {
        switchView(viewId);
    }

    function openSessionDetail(sessionId) {
        switchView('session-detail');
        updateCompletionBar();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab-item');
        tabs.forEach(t => {
            if(t.innerText.toLowerCase() === tabId) t.classList.add('active');
        });
        document.getElementById('tab-' + tabId).classList.add('active');
    }

    // ========== TOAST NOTIFICATIONS ==========
    function showToast(msg, icon = '✓') {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        document.querySelector('.toast-icon').innerText = icon;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ========== TRADE LOG FILTERS ==========
    function filterTrades(filter, btn) {
        // Update button states
        document.querySelectorAll('#tradelog-filters .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Filter rows
        const rows = document.querySelectorAll('#trade-table-body tr');
        rows.forEach(row => {
            const status = row.dataset.status;
            const stars = row.dataset.stars;
            
            if (filter === 'all') {
                row.style.display = '';
            } else if (filter === 'unrated') {
                row.style.display = status === 'unrated' ? '' : 'none';
            } else if (filter === '5star') {
                row.style.display = stars === '5' ? '' : 'none';
            }
        });
    }

    // ========== HIGHLIGHT FILTERS ==========
    function filterHighlights(filter, btn) {
        document.querySelectorAll('#highlight-filters .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const cards = document.querySelectorAll('#highlights-list .highlight-card');
        cards.forEach(card => {
            const tag = card.dataset.tag;
            const isPinned = card.classList.contains('pinned');
            
            if (filter === 'all') {
                card.style.display = '';
            } else if (filter === 'pinned') {
                card.style.display = isPinned ? '' : 'none';
            } else {
                card.style.display = tag === filter ? '' : 'none';
            }
        });
    }

    // ========== NOTES FILTERS & SEARCH ==========
    function filterNotes(filter, btn) {
        document.querySelectorAll('#notes-filters .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const cards = document.querySelectorAll('#notes-list .note-card');
        cards.forEach(card => {
            const isLinked = card.dataset.linked === 'true';
            if (filter === 'all') {
                card.style.display = '';
            } else if (filter === 'linked') {
                card.style.display = isLinked ? '' : 'none';
            }
        });
    }

    function searchNotes(query) {
        const cards = document.querySelectorAll('#notes-list .note-card');
        const q = query.toLowerCase();
        cards.forEach(card => {
            const title = card.querySelector('.note-title').innerText.toLowerCase();
            const preview = card.querySelector('.note-preview').innerText.toLowerCase();
            card.style.display = (title.includes(q) || preview.includes(q)) ? '' : 'none';
        });
    }

    // ========== SESSION REVIEW LOGIC ==========
    function updateCompletionBar() {
        const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
        steps.forEach((id, idx) => {
            const el = document.getElementById(id);
            el.classList.remove('done', 'active');
            
            if (idx === 0 && sessionReviewState.tradesRated) {
                el.classList.add('done');
                el.innerText = '1. Trades Reviewed ✅';
            } else if (idx === 1 && sessionReviewState.executionReviewed) {
                el.classList.add('done');
                el.innerText = '2. Execution Review ✅';
            } else if (idx === 2 && sessionReviewState.reflectionDone) {
                el.classList.add('done');
                el.innerText = '3. Reflection ✅';
            } else if (idx === 3 && sessionReviewState.highlightSelected) {
                el.classList.add('done');
                el.innerText = '4. Highlight Saved ✅';
            }
        });
        
        // Set active step
        if (!sessionReviewState.tradesRated) {
            document.getElementById('step-1').classList.add('active');
        } else if (!sessionReviewState.reflectionDone) {
            document.getElementById('step-2').classList.add('active');
            document.getElementById('step-3').classList.add('active');
        } else if (!sessionReviewState.highlightSelected) {
            document.getElementById('step-4').classList.add('active');
        }
    }

    function goToStep(step) {
        const sections = ['review-step-1', 'review-step-2', 'review-step-3', 'review-step-4'];
        const el = document.getElementById(sections[step - 1]);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function setMiniStar(tradeId, rating) {
        miniRatings[tradeId].stars = rating;
        const container = document.querySelector(`.star-rating[data-trade="${tradeId}"]`);
        const stars = container.querySelectorAll('.star');
        stars.forEach((star, idx) => {
            star.classList.toggle('active', idx < rating);
        });
    }

    function saveAllMiniRatings() {
        // Check if all trades have ratings
        let allRated = true;
        for (let id in miniRatings) {
            if (miniRatings[id].stars === 0) {
                allRated = false;
                break;
            }
        }
        
        if (!allRated) {
            showToast('Please rate all trades first', '⚠️');
            return;
        }
        
        sessionReviewState.tradesRated = true;
        document.getElementById('unrated-trades-section').style.display = 'none';
        document.getElementById('all-rated-section').style.display = 'block';
        document.getElementById('unrated-status').style.background = 'rgba(16, 185, 129, 0.1)';
        document.getElementById('unrated-status').style.color = 'var(--success)';
        document.getElementById('unrated-status').innerText = 'All Rated ✓';
        
        // Calculate average
        let total = 0;
        for (let id in miniRatings) {
            total += miniRatings[id].stars;
        }
        document.getElementById('avg-quality').innerText = (total / 3).toFixed(1);
        sessionReviewState.executionReviewed = true;
        
        updateCompletionBar();
        showToast('All trades rated successfully!');
    }

    function checkReflection() {
        const text = document.getElementById('reflection-input').value;
        sessionReviewState.reflectionDone = text.length > 10;
        updateCompletionBar();
    }

    function selectHighlight(el, text) {
        document.querySelectorAll('#highlight-options .option-btn').forEach(btn => btn.classList.remove('selected'));
        el.classList.add('selected');
        sessionReviewState.highlightSelected = text;
        document.getElementById('custom-highlight-box').classList.remove('active');
        updateCompletionBar();
    }

    function showCustomHighlight() {
        document.querySelectorAll('#highlight-options .option-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('custom-highlight-box').classList.add('active');
        sessionReviewState.highlightSelected = null;
        updateCompletionBar();
    }

    function customHighlightChanged() {
        const text = document.getElementById('custom-highlight-input').value;
        sessionReviewState.highlightSelected = text.length > 5 ? text : null;
        updateCompletionBar();
    }

    function saveCustomHighlight() {
        const text = document.getElementById('custom-highlight-input').value;
        if (text.length > 5) {
            sessionReviewState.highlightSelected = text;
            updateCompletionBar();
            showToast('Custom highlight saved!');
        }
    }

    function saveDraft() {
        showToast('Draft saved');
    }

    function tryCompleteSession() {
        if (!sessionReviewState.tradesRated) {
            showToast('Please rate all trades first', '⚠️');
            goToStep(1);
            return;
        }
        if (!sessionReviewState.highlightSelected) {
            showToast('Please select a highlight', '⚠️');
            goToStep(4);
            return;
        }
        completeSession();
    }

    function completeSession() {
        showToast('Session Completed & Closed! 🎉');
        setTimeout(() => switchView('sessionlog'), 1500);
    }

    function addSessionNote() {
        // Mock data lookup - in real app, fetch session by currentSessionId
        const sessionLink = { 
            type: 'session', 
            id: 's1', 
            icon: '📅', 
            title: 'Jan 02 Afternoon Session', 
            meta: 'From SessionLog' 
        };
        selectedLinks = [sessionLink];
        
        openDrawer('note-linked');
        // Pre-fill with session info
        setTimeout(() => {
            const titleInput = document.querySelector('#drawer-body input[type="text"]');
            if (titleInput) titleInput.value = 'Session Note · Jan 02 13:00-14:30';
        }, 100);
    }

    // ========== HIGHLIGHT ACTIONS ==========
    function togglePin(btn) {
        const card = btn.closest('.highlight-card');
        const isPinned = card.classList.toggle('pinned');
        btn.innerText = isPinned ? 'Unpin' : 'Pin';
        if (isPinned) {
            card.innerHTML = '<span class="pin-badge">📌</span>' + card.innerHTML.replace('<span class="pin-badge">📌</span>', '');
        } else {
            card.querySelector('.pin-badge')?.remove();
        }
        showToast(isPinned ? 'Highlight pinned' : 'Highlight unpinned');
    }

    function markReviewed(btn) {
        const card = btn.closest('.highlight-card');
        card.classList.add('reviewed');
        btn.parentElement.innerHTML = '<span style="color: var(--success); font-size: 11px;">✓ Reviewed today</span>';
        showToast('Marked as reviewed');
    }

    function openHighlightDetail(id) {
        const highlights = {
            1: { text: 'Avoid trading the first 5 mins of NQ open when VIX is above 20.', source: 'Jan 02 Session', tag: 'Strategy' },
            2: { text: 'Stop loss must be placed at technical levels, not dollar amounts.', source: 'Dec 30 Trade', tag: 'Discipline' },
            3: { text: 'Great patience on the pullback entry. Waited for the candle close.', source: 'Jan 01 Trade', tag: 'Mindset' },
            4: { text: 'When risk touched, I stepped back. Good emotional control.', source: 'Jan 01 Session', tag: 'Discipline' },
            5: { text: 'NQ respects the 15m VWAP in high volatility days.', source: 'Dec 28 Note', tag: 'Strategy' },
            6: { text: "Don't chase. If you miss it, there will be another setup.", source: 'Dec 27 Session', tag: 'Mindset' }
        };
        
        const h = highlights[id];
        document.getElementById('highlight-detail-body').innerHTML = `
            <div style="margin-bottom: 20px;">
                <div style="font-size: 18px; line-height: 1.5; margin-bottom: 15px; padding: 20px; background: var(--bg-panel); border-radius: 8px; border-left: 3px solid var(--primary);">
                    "${h.text}"
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <span class="tag">#${h.tag}</span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label class="form-label">Source</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>📅 ${h.source}</span>
                    <button class="btn btn-sm btn-outline">View Source</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" onclick="expandToNote(${id})">📝 Expand to Note</button>
                <button class="btn btn-outline" onclick="closeHighlightDetail(); showToast('Marked as reviewed');">✓ Mark Reviewed</button>
            </div>
        `;
        document.getElementById('highlight-detail-modal').classList.add('active');
    }

    function closeHighlightDetail() {
        document.getElementById('highlight-detail-modal').classList.remove('active');
    }

    function expandToNote(highlightId) {
        closeHighlightDetail();
        openDrawer('note');
        showToast('Note created from highlight');
    }

    // ========== UNRATED MODAL ==========
    function openUnratedModal() {
        document.getElementById('unrated-modal-body').innerHTML = `
            <p style="margin-bottom: 15px; color: var(--text-muted);">Rate these trades quickly (10 seconds each)</p>
            
            <div class="mini-trade-item">
                <div class="mini-trade-header">
                    <span><strong>NQ</strong> Long · +$120.00</span>
                    <span style="color: var(--text-muted);">14:15</span>
                </div>
                <div class="mini-trade-rating">
                    <div class="star-rating" data-trade="modal-1">
                        <span class="star" onclick="setModalStar('modal-1', 1)">★</span>
                        <span class="star" onclick="setModalStar('modal-1', 2)">★</span>
                        <span class="star" onclick="setModalStar('modal-1', 3)">★</span>
                        <span class="star" onclick="setModalStar('modal-1', 4)">★</span>
                        <span class="star" onclick="setModalStar('modal-1', 5)">★</span>
                    </div>
                    <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                        <option>No</option><option>Minor</option><option>Major</option>
                    </select>
                    <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                        <option>Discipline</option><option>Emotion</option><option>Noise</option><option>Execution</option>
                    </select>
                </div>
            </div>
            
            <div class="mini-trade-item">
                <div class="mini-trade-header">
                    <span><strong>ES</strong> Short · -$80.00</span>
                    <span style="color: var(--text-muted);">13:45</span>
                </div>
                <div class="mini-trade-rating">
                    <div class="star-rating" data-trade="modal-2">
                        <span class="star" onclick="setModalStar('modal-2', 1)">★</span>
                        <span class="star" onclick="setModalStar('modal-2', 2)">★</span>
                        <span class="star" onclick="setModalStar('modal-2', 3)">★</span>
                        <span class="star" onclick="setModalStar('modal-2', 4)">★</span>
                        <span class="star" onclick="setModalStar('modal-2', 5)">★</span>
                    </div>
                    <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                        <option>No</option><option>Minor</option><option>Major</option>
                    </select>
                    <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                        <option>Discipline</option><option>Emotion</option><option>Noise</option><option>Execution</option>
                    </select>
                </div>
            </div>
            
            <div class="mini-trade-item">
                <div class="mini-trade-header">
                    <span><strong>NQ</strong> Long · +$45.00</span>
                    <span style="color: var(--text-muted);">13:20</span>
                </div>
                <div class="mini-trade-rating">
                    <div class="star-rating" data-trade="modal-3">
                        <span class="star" onclick="setModalStar('modal-3', 1)">★</span>
                        <span class="star" onclick="setModalStar('modal-3', 2)">★</span>
                        <span class="star" onclick="setModalStar('modal-3', 3)">★</span>
                        <span class="star" onclick="setModalStar('modal-3', 4)">★</span>
                        <span class="star" onclick="setModalStar('modal-3', 5)">★</span>
                    </div>
                    <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                        <option>No</option><option>Minor</option><option>Major</option>
                    </select>
                    <select class="summary-input" style="width: auto; padding: 4px 8px; font-size: 12px;">
                        <option>Discipline</option><option>Emotion</option><option>Noise</option><option>Execution</option>
                    </select>
                </div>
            </div>
        `;
        document.getElementById('unrated-modal').classList.add('active');
    }

    function closeUnratedModal() {
        document.getElementById('unrated-modal').classList.remove('active');
    }

    function setModalStar(tradeId, rating) {
        const container = document.querySelector(`.star-rating[data-trade="${tradeId}"]`);
        const stars = container.querySelectorAll('.star');
        stars.forEach((star, idx) => star.classList.toggle('active', idx < rating));
    }

    function saveAllUnratedTrades() {
        closeUnratedModal();
        document.getElementById('pending-trades-bar').style.display = 'none';
        showToast('All trades rated successfully!');
    }

    // ========== DRAWER SYSTEM ==========
    function openDrawer(type, id = null) {
        if (type === 'trade') currentTradeId = id;

        const drawer = document.getElementById('main-drawer');
        const title = document.getElementById('drawer-title');
        const body = document.getElementById('drawer-body');
        const footer = document.querySelector('.drawer-footer');
        
        drawer.classList.add('open');

        if (type === 'trade') {
            title.innerText = 'Rate Trade';
            body.innerHTML = `
                <div class="moonlog-form">
                    <div style="background: var(--bg-panel); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 13px;"><strong>NQ</strong> Long · 14:15:22</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--success); margin-top: 5px;">+$120.00</div>
                    </div>
                    <div>
                        <label class="form-label">Execution Quality</label>
                        <div class="star-rating" id="drawer-stars">
                            <span class="star" onclick="setDrawerStar(1)">★</span>
                            <span class="star" onclick="setDrawerStar(2)">★</span>
                            <span class="star" onclick="setDrawerStar(3)">★</span>
                            <span class="star" onclick="setDrawerStar(4)">★</span>
                            <span class="star" onclick="setDrawerStar(5)">★</span>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Deviation</label>
                        <div class="option-grid" id="deviation-options">
                            <div class="option-btn selected" onclick="selectOption(this, 'deviation')">No Deviation</div>
                            <div class="option-btn" onclick="selectOption(this, 'deviation')">Minor</div>
                            <div class="option-btn" onclick="selectOption(this, 'deviation')">Major</div>
                            <div class="option-btn" onclick="selectOption(this, 'deviation')">Not Sure</div>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Factor</label>
                        <div class="option-grid" id="factor-options">
                            <div class="option-btn selected" onclick="selectOption(this, 'factor')">Discipline</div>
                            <div class="option-btn" onclick="selectOption(this, 'factor')">Emotion</div>
                            <div class="option-btn" onclick="selectOption(this, 'factor')">Market Noise</div>
                            <div class="option-btn" onclick="selectOption(this, 'factor')">Execution</div>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Tags (Optional)</label>
                        <div class="tag-cloud" id="trade-tags">
                            <span class="log-tag" onclick="toggleTag(this)">Entry</span>
                            <span class="log-tag" onclick="toggleTag(this)">Exit</span>
                            <span class="log-tag" onclick="toggleTag(this)">Sizing</span>
                            <span class="log-tag" onclick="toggleTag(this)">Timing</span>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Note (Optional)</label>
                        <textarea class="summary-input" rows="3" placeholder="Add a quick note..."></textarea>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="btn btn-sm btn-outline" style="flex: 1;" onclick="saveAsHighlight()">⭐ Save as Highlight</button>
                        <button class="btn btn-sm btn-outline" style="flex: 1;" onclick="addTradeNote()">📝 Add Note</button>
                    </div>
                </div>
            `;
            footer.innerHTML = `
                <button class="btn btn-outline" onclick="closeDrawer()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTrade()">Save Rating</button>
            `;

        } else if (type === 'note' || type === 'note-detail' || type === 'note-linked') {
            // Reset links for new note, or load existing for edit
            if (type === 'note') {
                selectedLinks = [];
            } else if (type === 'note-linked') {
                // Keep existing selectedLinks (passed from addTradeNote)
            } else {
                // Simulate existing links for demo
                selectedLinks = [
                    { type: 'session', id: 's2', icon: '📅', title: 'Jan 02 Morning Session' }
                ];
            }
            
            title.innerText = (type === 'note' || type === 'note-linked') ? 'New Note' : 'Edit Note';
            body.innerHTML = `
                <div class="moonlog-form">
                    <div>
                        <label class="form-label">Title</label>
                        <input type="text" class="summary-input" id="note-title" placeholder="Untitled Note" value="${type === 'note-detail' ? 'Weekly Review - Week 50' : ''}">
                    </div>
                    <div>
                        <label class="form-label">Type</label>
                        <div class="tag-cloud" id="note-type-tags">
                            <span class="log-tag selected" onclick="selectNoteType(this)">📝 Review</span>
                            <span class="log-tag" onclick="selectNoteType(this)">🎯 Strategy</span>
                            <span class="log-tag" onclick="selectNoteType(this)">🧠 Mindset</span>
                            <span class="log-tag" onclick="selectNoteType(this)">📈 Market</span>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Content</label>
                        <textarea class="summary-input" id="note-content" rows="10" placeholder="Start writing...">${type === 'note-detail' ? 'Overall a good week. Focused on execution quality rather than P&L. The new scalping strategy is working well in high volatility...' : ''}</textarea>
                    </div>
                    <div class="insight-box">
                        <label class="form-label" style="color: var(--primary); margin-bottom: 10px;">🔗 Link to... (Optional)</label>
                        <div class="tag-cloud" style="margin-bottom: 12px;">
                            <span class="log-tag" onclick="addLink('session')">+ Session</span>
                            <span class="log-tag" onclick="addLink('trade')">+ Trade</span>
                            <span class="log-tag" onclick="addLink('blueprint')">+ Blueprint</span>
                            <span class="log-tag" onclick="addLink('highlight')">+ Highlight</span>
                        </div>
                        <div class="link-chips" id="note-links">
                            <!-- Linked items will appear here -->
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-sm btn-outline" style="width: 100%; border-style: dashed;" onclick="extractHighlightFromNote()">✨ Extract Highlight from Note</button>
                    </div>
                </div>
            `;
            
            // Render existing links after DOM is ready
            setTimeout(() => renderLinkChips(), 50);
            
            footer.innerHTML = `
                <button class="btn btn-outline" onclick="closeDrawer()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
            `;
        }
    }

    function closeDrawer() {
        document.getElementById('main-drawer').classList.remove('open');
    }

    function setDrawerStar(rating) {
        const stars = document.querySelectorAll('#drawer-stars .star');
        stars.forEach((star, idx) => star.classList.toggle('active', idx < rating));
    }

    function selectOption(el, group) {
        const container = el.parentElement;
        container.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
        el.classList.add('selected');
    }

    function toggleTag(el) {
        el.classList.toggle('selected');
    }

    function selectNoteType(el) {
        document.querySelectorAll('#note-type-tags .log-tag').forEach(t => t.classList.remove('selected'));
        el.classList.add('selected');
    }

    // ========== LINK SYSTEM ==========
    const linkableItems = {
        session: [
            { id: 's1', icon: '📅', title: 'Jan 02 Afternoon Session', meta: '13:00-14:30 • 5 trades • +$85' },
            { id: 's2', icon: '📅', title: 'Jan 02 Morning Session', meta: '09:00-11:30 • 8 trades • +$540' },
            { id: 's3', icon: '📅', title: 'Jan 01 Morning Session', meta: '09:30-12:00 • 6 trades • +$320' },
            { id: 's4', icon: '📅', title: 'Dec 30 Session', meta: '10:00-14:00 • 12 trades • -$150' }
        ],
        trade: [
            { id: 't1', icon: '📊', title: 'NQ Long +$120.00', meta: 'Jan 02 14:15 • ⭐⭐⭐⭐⭐' },
            { id: 't2', icon: '📊', title: 'ES Short -$80.00', meta: 'Jan 02 13:45 • ⭐⭐⭐' },
            { id: 't3', icon: '📊', title: 'NQ Long +$350.00', meta: 'Jan 02 09:45 • ⭐⭐⭐⭐⭐' },
            { id: 't4', icon: '📊', title: 'ES Short +$75.00', meta: 'Jan 01 10:30 • ⭐⭐⭐⭐' }
        ],
        blueprint: [
            { id: 'b1', icon: '📘', title: 'Scalping Strategy', meta: 'NQ/ES • 68% Win Rate' },
            { id: 'b2', icon: '📘', title: 'Breakout Hunter', meta: 'NQ • 72% Win Rate' },
            { id: 'b3', icon: '📘', title: 'Mean Reversion', meta: 'ES • 65% Win Rate' }
        ],
        highlight: [
            { id: 'h1', icon: '⭐', title: 'Avoid trading first 5 mins of NQ open...', meta: 'Jan 02 • #Strategy' },
            { id: 'h2', icon: '⭐', title: 'Stop loss at technical levels...', meta: 'Dec 30 • #Discipline' },
            { id: 'h3', icon: '⭐', title: 'Great patience on pullback entry...', meta: 'Jan 01 • #Mindset' },
            { id: 'h4', icon: '⭐', title: 'When risk touched, stepped back...', meta: 'Jan 01 • #Discipline' }
        ]
    };

    let currentLinkType = null;
    let selectedLinks = [];
    let currentTradeId = null;

    function addLink(type) {
        currentLinkType = type;
        const typeLabels = {
            session: 'Select Session to Link',
            trade: 'Select Trade to Link',
            blueprint: 'Select Blueprint to Link',
            highlight: 'Select Highlight to Link'
        };
        
        document.getElementById('link-modal-title').innerText = typeLabels[type];
        
        const items = linkableItems[type];
        let html = '';
        
        items.forEach(item => {
            const isSelected = selectedLinks.some(l => l.id === item.id);
            html += `
                <div class="link-select-item ${isSelected ? 'selected' : ''}" onclick="selectLinkItem('${type}', '${item.id}', '${item.icon}', '${item.title}')">
                    <span class="link-select-icon">${item.icon}</span>
                    <div class="link-select-info">
                        <div class="link-select-title">${item.title}</div>
                        <div class="link-select-meta">${item.meta}</div>
                    </div>
                    <span class="link-select-check">✓</span>
                </div>
            `;
        });
        
        document.getElementById('link-modal-body').innerHTML = html;
        document.getElementById('link-modal').classList.add('active');
    }

    function selectLinkItem(type, id, icon, title) {
        // Check if already linked
        const existingIndex = selectedLinks.findIndex(l => l.id === id);
        
        if (existingIndex >= 0) {
            // Remove if already selected
            selectedLinks.splice(existingIndex, 1);
        } else {
            // Add new link
            selectedLinks.push({ type, id, icon, title: title.length > 30 ? title.substring(0, 30) + '...' : title });
        }
        
        // Update modal UI
        document.querySelectorAll('.link-select-item').forEach(item => {
            const itemId = item.querySelector('.link-select-title').innerText;
            const isSelected = selectedLinks.some(l => l.title.startsWith(itemId.substring(0, 20)) || itemId.startsWith(l.title.substring(0, 20)));
        });
        
        // Refresh the link chips in drawer
        renderLinkChips();
        
        // Close modal after selection
        closeLinkModal();
        showToast(`${icon} Linked successfully`);
    }

    function renderLinkChips() {
        const container = document.getElementById('note-links');
        if (!container) return;
        
        if (selectedLinks.length === 0) {
            container.innerHTML = '<span style="font-size: 11px; color: var(--text-muted);">No links added yet</span>';
            return;
        }
        
        container.innerHTML = selectedLinks.map(link => `
            <span class="link-chip">
                ${link.icon} ${link.title}
                <span class="remove" onclick="removeLink('${link.id}')">×</span>
            </span>
        `).join('');
    }

    function removeLink(id) {
        selectedLinks = selectedLinks.filter(l => l.id !== id);
        renderLinkChips();
        showToast('Link removed');
    }

    function closeLinkModal() {
        document.getElementById('link-modal').classList.remove('active');
    }

    function saveTrade() {
        showToast('Trade Rated Successfully');
        closeDrawer();
    }

    function saveNote() {
        showToast('Note Saved');
        closeDrawer();
    }

    function saveAsHighlight() {
        showToast('Saved as Highlight ⭐');
    }

    function addTradeNote() {
        // Mock data lookup - in real app, fetch trade by currentTradeId
        const tradeLink = { 
            type: 'trade', 
            id: currentTradeId || 't1', 
            icon: '📊', 
            title: 'Linked Trade (NQ)', 
            meta: 'From TradeLog' 
        };
        selectedLinks = [tradeLink];
        
        closeDrawer();
        setTimeout(() => openDrawer('note-linked'), 300);
    }

    function extractHighlightFromNote() {
        const content = document.getElementById('note-content')?.value || '';
        if (content.length < 10) {
            showToast('Write some content first', '⚠️');
            return;
        }
        showToast('Highlight Extracted to Library ⭐');
    }

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view') || 'missioncontrol';
        switchView(view);
        updateSidebarActive(view);
        
        // Initialize completion bar if on session-detail view
        if (view === 'session-detail') {
            updateCompletionBar();
        }
    });
</script>

</body>
</html>
